name: CI Integration Tests

on:
  push:
    branches: [main]
  workflow_dispatch:  # Manual trigger only for now

permissions:
  contents: read

env:
  JWT_SECRET: test_secret_key_for_ci_environment_only_32
  DATABASE_URL: postgresql://apex:apex@localhost:5432/test

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Integration Tests (Manual Only - Skipping MinIO for now)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-api-integration:
    name: 'API Integration Tests'
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: apex
          POSTGRES_PASSWORD: apex
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      # MinIO disabled temporarily - using mocks instead
    steps:
      - uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: packages
      - name: Run Schema Migrations
        run: |
          cd packages/db
          bun run db:migrate
        env:
          DATABASE_URL: postgresql://apex:apex@localhost:5432/test
      - name: Run API Tests
        run: |
          cd apps/api
          bun run test
        env:
          DATABASE_URL: postgresql://apex:apex@localhost:5432/test
          JWT_SECRET: test_secret_key_for_ci_environment_only_32
          MINIO_ACCESS_KEY: test
          MINIO_SECRET_KEY: minioadmin123
          MINIO_ENDPOINT: localhost
          # Using MinIO mock for now

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # S2 Data Isolation Check
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  s2-data-isolation-check:
    name: 'S2 Data Isolation Check'
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: apex
          POSTGRES_PASSWORD: apex
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Run S2 Isolation Checker
        run: |
          if [ -f scripts/check-s2-isolation.ts ]; then
            bun run scripts/check-s2-isolation.ts
          else
            echo "âš ï¸ S2 checker not found, skipping"
          fi
      - name: Check SQL Queries for Tenant Isolation
        run: |
          violations=""
          public_refs=$(grep -r "public\." packages/db/src --include="*.ts" 2>/dev/null | grep -v "\.test\." | grep -v "// " | grep -v "search_path" | grep -v "information_schema" || true)
          if [ -n "$public_refs" ]; then
            violations="$violations\nâŒ Direct 'public.' schema reference found:\n$public_refs"
          fi
          if [ -n "$violations" ]; then
            echo "ğŸš¨ S2 VIOLATION DETECTED!"
            echo -e "$violations"
            exit 1
          fi
          echo "âœ… PASS: No S2 violations found"
      - name: Run Post-Migration Tenant Isolation Test
        run: |
          psql "$DATABASE_URL" -c "CREATE SCHEMA IF NOT EXISTS tenant_test_s2;" || true
          psql "$DATABASE_URL" -c "CREATE TABLE IF NOT EXISTS tenant_test_s2.products (id serial PRIMARY KEY, name text);" || true
          psql "$DATABASE_URL" -c "INSERT INTO tenant_test_s2.products (name) VALUES ('Test Product') ON CONFLICT DO NOTHING;"
          psql "$DATABASE_URL" -c "DROP SCHEMA IF EXISTS tenant_test_s2 CASCADE;" || true
          echo "âœ… S2 test completed"
        env:
          DATABASE_URL: postgresql://apex:apex@localhost:5432/test

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Docker Stack Verification
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  docker-health:
    name: 'Docker Stack E2E Ready'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Docker
        uses: docker/setup-buildx-action@v3
      - name: Start infrastructure
        run: |
          docker compose up -d --wait || {
            echo "âŒ Docker compose failed to start"
            docker compose logs
            exit 1
          }
      - name: Verify Service Status
        run: |
          docker compose ps
          docker compose exec -T postgres pg_isready -h localhost || exit 1
          docker compose exec -T redis redis-cli ping || exit 1
      - name: Cleanup
        if: always()
        run: docker compose down -v
