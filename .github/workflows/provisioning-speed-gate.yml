name: "âš¡ Provisioning Speed Gate (60s North Star)"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  checks: write

jobs:
  provisioning-speed-test:
    name: "â±ï¸ 60-Second Provisioning Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 3

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: apex_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install

      - name: Setup Test Database
        run: |
          bun run db:push
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/apex_test
          REDIS_URL: redis://localhost:6379

      - name: "â±ï¸ NORTH STAR: Provision in Under 60 Seconds"
        id: provision-test
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¯ NORTH STAR GOAL: Provision store in < 60 seconds"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Generate unique subdomain
          SUBDOMAIN="perf-test-$(date +%s)"

          # Start timer
          START_TIME=$(date +%s)

          # Execute provisioning
          echo "ğŸš€ Starting provisioning for subdomain: ${SUBDOMAIN}"
          bun run cli provision \
            --subdomain="${SUBDOMAIN}" \
            --plan=basic \
            --email="test@${SUBDOMAIN}.com" \
            --password="TestPass123!" \
            --store-name="Speed Test Store" \
            --quiet

          # End timer
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â±ï¸ PROVISIONING COMPLETED IN: ${DURATION} SECONDS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Validate against threshold
          THRESHOLD=55  # 55s to have buffer before 60s

          if [ $DURATION -gt $THRESHOLD ]; then
            echo ""
            echo "âŒ CRITICAL FAILURE: NORTH STAR VIOLATED"
            echo ""
            echo "Expected: < ${THRESHOLD}s (buffer for 60s goal)"
            echo "Actual:   ${DURATION}s"
            echo "Exceeded: $((DURATION - THRESHOLD))s"
            echo ""
            echo "ğŸ”´ This exceeds our 60-second North Star commitment"
            echo "ğŸ”´ Customer experience degraded"
            echo "ğŸ”´ Performance optimization REQUIRED"
            echo ""
            exit 1
          fi

          echo ""
          echo "âœ… NORTH STAR ACHIEVED!"
          echo "âœ… Provisioning time: ${DURATION}s (threshold: ${THRESHOLD}s)"
          echo ""

          # Save metrics
          echo "DURATION=${DURATION}" >> $GITHUB_OUTPUT
          echo "THRESHOLD=${THRESHOLD}" >> $GITHUB_OUTPUT
          echo "SUBDOMAIN=${SUBDOMAIN}" >> $GITHUB_OUTPUT
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/apex_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test

      - name: Verify Provisioned Store
        run: |
          echo "ğŸ” Verifying provisioned store integrity..."

          SUBDOMAIN="${{ steps.provision-test.outputs.SUBDOMAIN }}"

          # Check tenant exists in database
          TENANT_COUNT=$(bunx drizzle-kit query \
            --query "SELECT COUNT(*) FROM tenants WHERE subdomain='${SUBDOMAIN}'" \
            --database-url="${DATABASE_URL}" || echo "0")

          if [ "$TENANT_COUNT" = "0" ]; then
            echo "âŒ Tenant not found in database"
            exit 1
          fi

          echo "âœ… Tenant verified in database"

          # Check schema exists
          SCHEMA_EXISTS=$(bunx drizzle-kit query \
            --query "SELECT schema_name FROM information_schema.schemata WHERE schema_name='tenant_${SUBDOMAIN}'" \
            --database-url="${DATABASE_URL}" || echo "")

          if [ -z "$SCHEMA_EXISTS" ]; then
            echo "âŒ Tenant schema not created"
            exit 1
          fi

          echo "âœ… Tenant schema created"
          echo "âœ… Store provisioning integrity verified"
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/apex_test

      - name: Performance Breakdown (Optional)
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š PROVISIONING PERFORMANCE BREAKDOWN"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Total Time:      ${{ steps.provision-test.outputs.DURATION }}s"
          echo "Threshold:       ${{ steps.provision-test.outputs.THRESHOLD }}s"
          echo "North Star Goal: 60s"
          echo ""
          echo "Typical breakdown (target):"
          echo "  â€¢ Tenant record:     ~2s"
          echo "  â€¢ Schema creation:   ~15s"
          echo "  â€¢ Seed data:         ~20s"
          echo "  â€¢ Storefront build:  ~15s"
          echo "  â€¢ Final validation:  ~3s"
          echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "  â€¢ Total:             ~55s"
          echo ""

      - name: Report Failure
        if: failure()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš¨ PROVISIONING SPEED GATE FAILED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âŒ The 60-second North Star goal was VIOLATED"
          echo ""
          
          # Handle empty values with defaults
          DURATION="${{ steps.provision-test.outputs.DURATION }}"
          THRESHOLD="${{ steps.provision-test.outputs.THRESHOLD }}"
          
          if [ -z "$DURATION" ]; then
            DURATION="UNKNOWN"
            echo "ğŸ“‹ Performance Issue Detected:"
            echo "   - Provisioning failed before timing completed"
            echo "   - Check logs above for specific errors"
          else
            if [ -z "$THRESHOLD" ]; then
              THRESHOLD=55
            fi
            EXCEEDED=$((DURATION - THRESHOLD))
            echo "ğŸ“‹ Performance Issue Detected:"
            echo "   - Provisioning took: ${DURATION}s"
            echo "   - Threshold exceeded by: ${EXCEEDED}s"
          fi
          
          echo ""
          echo "ğŸ”’ Impact:"
          echo "   - Customer onboarding delayed"
          echo "   - North Star commitment broken"
          echo "   - Competitive advantage lost"
          echo ""
          echo "ğŸ“ Action Required:"
          echo "   1. Profile slow queries (check logs above)"
          echo "   2. Optimize schema creation process"
          echo "   3. Consider parallel seed data insertion"
          echo "   4. Review Storefront build process"
          echo ""
          echo "ğŸ›‘ Build rejected. Optimize before merging."
          exit 1

      - name: Report Success
        if: success()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… PROVISIONING SPEED GATE PASSED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ¯ North Star Goal: ACHIEVED"
          echo ""
          echo "Performance metrics:"
          echo "  âœ“ Provisioning time: ${{ steps.provision-test.outputs.DURATION }}s"
          echo "  âœ“ Threshold: ${{ steps.provision-test.outputs.THRESHOLD }}s"
          echo "  âœ“ Buffer remaining: $((${{ steps.provision-test.outputs.THRESHOLD }} - ${{ steps.provision-test.outputs.DURATION }}))s"
          echo ""
          echo "âš¡ Store live in under 60 seconds - Customer satisfaction guaranteed"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
