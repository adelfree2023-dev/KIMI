name: S1-S8 Security Compliance CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write

env:
  JWT_SECRET: test_secret_key_for_ci_environment_only_32
  DATABASE_URL: postgresql://test:test@localhost:5432/test
  MINIO_ACCESS_KEY: test
  MINIO_SECRET_KEY: minioadmin123
  MINIO_ENDPOINT: localhost

jobs:
  secret-scan:
    name: Secret Scanning (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  s1-compliance:
    name: S1 Environment Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Test S1 Crash on Invalid JWT_SECRET
        run: |
          # Test 1: Missing JWT_SECRET should crash
          if JWT_SECRET="" bun run packages/config/src/index.ts 2>&1; then
            echo "❌ FAIL: App should have crashed with empty JWT_SECRET"
            exit 1
          else
            echo "✅ PASS: App crashed as expected with empty JWT_SECRET"
          fi

          # Test 2: Short JWT_SECRET should crash
          if JWT_SECRET="short" bun run packages/config/src/index.ts 2>&1; then
            echo "❌ FAIL: App should have crashed with short JWT_SECRET"
            exit 1
          else
            echo "✅ PASS: App crashed as expected with short JWT_SECRET"
          fi

          # Test 3: Valid JWT_SECRET should pass
          if bun run packages/config/src/index.ts 2>&1; then
            echo "✅ PASS: App started with valid JWT_SECRET"
          else
            echo "❌ FAIL: App should have started with valid JWT_SECRET"
            exit 1
          fi

  security-audit-lint:
    name: Security Audit & Linting (Strict)
    runs-on: ubuntu-latest
    needs: [secret-scan]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Security Audit (S1 - Critical/High)
        run: bun audit

      - name: TypeScript Check (Strict Mode)
        run: bun x tsc --noEmit --strict

      - name: Biome CI (Strict)
        run: bun run biome ci .

      - name: Verify no console.log (S4 Compliance)
        run: |
          if grep -r "console.log" packages/*/src/*.ts --include="*.ts" | grep -v "console.warn" | grep -v "console.error"; then
            echo "❌ FAIL: console.log found. Use structured logging instead (S4)."
            exit 1
          fi

  db-schema-validation:
    name: Drizzle Schema Integrity Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Validate Drizzle Schema (Drift Check)
        run: |
          cd packages/db
          # Ensure schema matches migrations (prevents accidental data loss)
          bunx drizzle-kit check:pg || (echo "❌ Schema drift detected! Run db:generate locally." && exit 1)

  build:
    name: Turborepo Build
    runs-on: ubuntu-latest
    needs: [s1-compliance, security-audit-lint, db-schema-validation]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build all packages
        run: bun run turbo run build

      - name: Verify build outputs
        run: |
          test -d packages/config/dist || (echo "❌ config build missing" && exit 1)
          test -d packages/db/dist || (echo "❌ db build missing" && exit 1)
          test -d packages/auth/dist || (echo "❌ auth build missing" && exit 1)
          echo "✅ All packages built successfully"

      - name: Generate Artifact Checksums
        run: |
          find packages/*/dist -type f -exec sha256sum {} \; > build_checksums.txt
          cat build_checksums.txt

  test-api-integration:
    name: API Integration Tests (Postgres/Redis/MinIO)
    runs-on: ubuntu-latest
    needs: [build]
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: apex
          POSTGRES_PASSWORD: apex
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      minio:
        image: minio/minio
        env:
          MINIO_ROOT_USER: test
          MINIO_ROOT_PASSWORD: minioadmin123
        ports:
          - 9000:9000
          - 9001:9001
        options: >-
          --health-cmd "curl -f http://localhost:9000/minio/health/live"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --entrypoint minio
          server /data --console-address ":9001"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run Schema Migrations
        run: |
          cd packages/db
          bun run db:migrate
        env:
          DATABASE_URL: postgresql://apex:apex@localhost:5432/test

      - name: Run API Tests with Coverage
        run: |
          cd apps/api
          bun run test:cov
        env:
          DATABASE_URL: postgresql://apex:apex@localhost:5432/test
          JWT_SECRET: test_secret_key_for_ci_environment_only_32
          MINIO_ACCESS_KEY: test
          MINIO_SECRET_KEY: minioadmin123
          MINIO_ENDPOINT: localhost

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: api-coverage-report
          path: apps/api/coverage/

  docker-health:
    name: Docker Stack E2E Ready Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Start infrastructure (Wait for Health)
        run: |
          docker compose up -d --wait || {
            echo "❌ Docker compose failed to start"
            docker compose logs
            exit 1
          }

      - name: Verify Service Status
        run: |
          docker compose ps
          docker compose ps --all

          # Explicitly check each service
          docker compose exec -T postgres pg_isready -h localhost || exit 1
          docker compose exec -T redis redis-cli ping || exit 1

      - name: Cleanup
        if: always()
        run: docker compose down -v
