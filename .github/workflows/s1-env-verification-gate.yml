name: "ğŸ” S1 Environment Verification Gate"

on:
  workflow_call:

permissions:
  contents: read
  checks: write

env:
  DATABASE_URL: postgresql://test:test@localhost:5432/test
  JWT_SECRET: test_secret_key_for_ci_environment_only_32
  MINIO_ENDPOINT: localhost
  MINIO_ACCESS_KEY: test_access_key
  MINIO_SECRET_KEY: test_secret_key

jobs:
  s1-environment-verification:
    name: "S1 Environment Verification Security Test"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          cache: false

      - name: Install Dependencies
        run: bun install

      - name: "S1.1 - Secret Detection (Gitleaks)"
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_COMMENTS: 'false'

      - name: "S1.2 - Hardcoded Credentials & Secret Strength Scan"
        run: |
          echo "ğŸ” Scanning for hardcoded credentials (Surgical)..."
          
          # Detect password/secret assignments in strings (active code only)
          # Excludes comments, tests, and explicit safe marks
          HARDCODED=$(grep -rnE "(password|secret|apiKey|token)\s*=\s*['\"][^'\"]+['\"]" packages/*/src apps/*/src \
            --include="*.ts" 2>/dev/null | \
            grep -vE "^\s*//" | \
            grep -vE "(\.test\.|\.spec\.|// S1: safe)" || true)

          if [ -n "$HARDCODED" ]; then
            echo "ğŸš¨ CRITICAL: Hardcoded credentials found in active code!"
            echo "$HARDCODED"
            exit 1
          fi

          echo "ğŸ” S1.2: Hardcoded credentials check passed"

          echo "ğŸ” Verifying JWT_SECRET length (Min 32 chars)..."
          # Check JWT_SECRET in .env.example
          if [ -f ".env.example" ]; then
            JWT_VAL=$(grep "^JWT_SECRET=" .env.example | cut -d= -f2 | tr -d '"' | tr -d "'")
            JWT_LEN=${#JWT_VAL}
            echo "Found JWT_SECRET with length: $JWT_LEN"
            if [ $JWT_LEN -lt 32 ]; then
              echo "ğŸš¨ CRITICAL: JWT_SECRET in .env.example is too short (Found: $JWT_LEN, Min: 32)!"
              exit 1
            fi
          fi
          
          echo "âœ… S1.2: JWT Secret strength verified"

      - name: "S1.3 - Environment vs Schema Consistency"
        run: |
          echo "ğŸ” Verifying .env.example vs @apex/config schema..."
          bun run tools/security-scripts/verify-env-config.ts

      - name: "S1.4 - Forbidden .env Commits"
        run: |
          echo "ğŸ” Checking for illegally committed .env files..."
          ENV_FILES=$(find . -name ".env" -not -path "*/node_modules/*" 2>/dev/null || true)

          if [ -n "$ENV_FILES" ]; then
            echo "ğŸš¨ CRITICAL: .env files found in repository!"
            echo "$ENV_FILES"
            exit 1
          fi
          
          echo "âœ… S1.4: No .env files committed"

      - name: "S1.5 - Dependency Vulnerability Audit (Bun Audit)"
        run: |
          echo "ğŸ” Running supply chain security audit..."
          bun audit || {
            echo "âŒ S1.5 FAILED: Known security vulnerabilities detected in dependencies!"
            exit 1
          }
          echo "âœ… S1.5: Dependency audit passed"

      - name: S1 Final Report
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           S1 ENVIRONMENT VERIFICATION COMPLETE                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
