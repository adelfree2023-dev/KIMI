name: "ğŸ” S1 Environment Verification Gate"

on:
  workflow_call: # Only called by aggregator to avoid duplicates

permissions:
  contents: read
  checks: write

jobs:
  s1-environment-verification:
    name: "S1 Environment Verification Security Test"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for Gitleaks

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Check for Secrets in Code (Gitleaks)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE || 'free' }}
          GITLEAKS_ENABLE_COMMENTS: 'false'

      - name: Verify Environment Variables Structure
        run: |
          echo "ğŸ” Verifying environment variable patterns..."

          # Check that sensitive vars use process.env, not hardcoded
          HARDCODED_SECRETS=$(grep -rn "password.*=.*['\"]" packages/*/src apps/*/src --include="*.ts" 2>/dev/null | \
            grep -v "\.test\." | \
            grep -v "\.spec\." | \
            grep -v "// S1: safe" || echo "")

          if [ -n "$HARDCODED_SECRETS" ]; then
            echo "ğŸš¨ WARNING: Potential hardcoded credentials detected"
            echo "$HARDCODED_SECRETS"
          else
            echo "âœ… No hardcoded credentials found"
          fi

      - name: Verify Config Package Exports
        run: |
          echo "ğŸ” Checking @apex/config package..."

          if [ ! -f "packages/config/src/index.ts" ]; then
            echo "âŒ Config package not found"
            exit 1
          fi

          # Verify config exports environment validation
          if ! grep -q "process\.env" packages/config/src/index.ts; then
            echo "âš ï¸ WARNING: Config package may not be reading environment variables"
          else
            echo "âœ… Config package uses environment variables"
          fi

      - name: Check for .env Files (Should Not Be Committed)
        run: |
          echo "ğŸ” Checking for committed .env files..."

          # .env files should NOT be in git (only .env.example is allowed)
          ENV_FILES=$(find . -name ".env" -not -path "*/node_modules/*" 2>/dev/null || echo "")

          if [ -n "$ENV_FILES" ]; then
            echo "ğŸš¨ CRITICAL: .env files found in repository!"
            echo "$ENV_FILES"
            echo "These files should be in .gitignore"
            exit 1
          fi

          echo "âœ… No .env files committed to repository"

      - name: Report Failure
        if: failure()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš¨ S1 ENVIRONMENT VERIFICATION GATE FAILED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ CRITICAL: Environment security violations detected!"
          echo ""
          echo "ğŸ“‹ S1 Protocol Violation Details:"
          echo "   - Secrets leaked in code or committed .env files"
          echo "   - Or hardcoded credentials found"
          echo "   - Risk: Credential exposure"
          echo ""
          echo "ğŸ”’ Security Impact:"
          echo "   - CRITICAL: API keys, passwords may be exposed"
          echo "   - HIGH: Security breach via source code"
          echo ""
          echo "ğŸ“ Action Required:"
          echo "   1. Remove all secrets from code"
          echo "   2. Use environment variables via @apex/config"
          echo "   3. Add .env to .gitignore"
          echo "   4. Rotate any exposed credentials"
          echo ""
          echo "ğŸ›‘ Build rejected. Fix S1 violation before merging."
          exit 1

      - name: Report Success
        if: success()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… S1 ENVIRONMENT VERIFICATION GATE PASSED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "All environment security checks passed:"
          echo "  âœ“ No secrets leaked (Gitleaks scan clean)"
          echo "  âœ“ No hardcoded credentials"
          echo "  âœ“ No .env files committed"
          echo "  âœ“ Config package properly configured"
          echo ""
          echo "ğŸ” Environment security validated"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
