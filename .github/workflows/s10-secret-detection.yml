# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# S10: Secret Detection & Leak Prevention
# Scans code for accidentally committed secrets
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

name: "üîí S10: Secret Detection Gate"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  secret-scan:
    name: "üïµÔ∏è Secret Leak Detection"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better scanning
          
      - name: Install Gitleaks
        run: |
          wget -q -O gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz
          tar -xzf gitleaks.tar.gz
          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/
          
      - name: Run secret detection scan
        run: |
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "              üïµÔ∏è  SECRET DETECTION SCAN"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          # Run gitleaks with verbose output
          gitleaks detect --source . --verbose --redact --report-format json --report-path gitleaks-report.json || true
          
          # Check if any secrets were found
          if [ -s gitleaks-report.json ] && [ "$(cat gitleaks-report.json)" != "[]" ]; then
            echo ""
            echo "üö®üö®üö® POTENTIAL SECRETS DETECTED üö®üö®üö®"
            echo ""
            echo "The following secrets may have been committed:"
            cat gitleaks-report.json | jq -r '.[] | "  - \(.Description): \(.File)"' 2>/dev/null || cat gitleaks-report.json
            echo ""
            echo "‚ö†Ô∏è  ACTION REQUIRED:"
            echo "  1. Rotate the exposed credentials immediately"
            echo "  2. Use 'git-filter-repo' to remove from history"
            echo "  3. Add to .gitignore or use .env files"
            echo ""
            exit 1
          fi
          
          echo "‚úÖ No secrets detected in code"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

      - name: Check for hardcoded credentials patterns
        run: |
          echo "üîç Checking for hardcoded credential patterns..."
          
          # Patterns to check
          PATTERNS="(password|passwd|pwd|secret|key|token|api_key)\s*[=:]\s*['\"][^'\"]+['\"]"
          
          # Exclude test files and config examples
          EXCLUDE="--exclude-dir=node_modules --exclude-dir=.git --exclude=*.test.ts --exclude=*example* --exclude=*.md"
          
          # Search for patterns
          MATCHES=$(grep -riE $EXCLUDE "$PATTERNS" . 2>/dev/null | grep -v "//\|#\|/\*" | head -20 || true)
          
          if [ -n "$MATCHES" ]; then
            echo "‚ö†Ô∏è  WARNING: Potential hardcoded credentials found:"
            echo "$MATCHES"
            echo ""
            echo "Review these files to ensure no real credentials are exposed"
          fi
          
          echo "‚úÖ Pattern scan complete"

      - name: Upload scan report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-report
          path: gitleaks-report.json
          retention-days: 30
