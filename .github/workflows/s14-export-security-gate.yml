# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# S14: Export Security Gate (S2 Compliance Verification)
# Refined Surgical Scans and Resource Optimization
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "S14 Export Security Gate"

on:
  workflow_call:
  workflow_dispatch:

jobs:
  s14-export-security:
    name: "S14: Export System Security"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # [OPTIMIZATION] Removed unused Postgres and Redis services
    # All checks are architectural/static via surgical greps.

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          cache: true

      - name: Install Dependencies
        run: bun install

      - name: "S14.1 - Tenant Isolation Verification (S2)"
        run: |
          echo "Verifying S2 Tenant Isolation in Export System..."
          
          # [STRUCTURAL] Ensure critical files exist
          if [ ! -f "packages/export/src/export.service.ts" ]; then echo "âŒ Missing export.service.ts"; exit 1; fi
          
          # Check active schema isolation (must not be in comments)
          ACTIVE_ISOLATION=$(grep -r "schemaName" packages/export/src --include="*.ts" 2>/dev/null | grep -vE "^\s*//" || true)
          
          if [ -z "$ACTIVE_ISOLATION" ]; then
            echo "ğŸš¨ CRITICAL: No active tenant schema isolation found in export queries!"
            echo "âŒ S14.1 FAILED: Tenant isolation gate violation."
            exit 1
          fi
          
          # Verify no public schema leaks in active code
          PUBLIC_LEAKS=$(grep -rn "public\." packages/export/src --include="*.ts" 2>/dev/null | grep -vE "^\s*//" | grep -vE "(public.tenants|audit)" || true)
          if [ -n "$PUBLIC_LEAKS" ]; then
            echo "ğŸš¨ CRITICAL: Potential cross-tenant leak found (public. prefix):"
            echo "$PUBLIC_LEAKS"
            exit 1
          fi
          
          echo "âœ… S14.1: Tenant isolation verified"

      - name: "S14.2 - Strategy Pattern & Implementation"
        run: |
          echo "Validating Export Strategy Implementation..."
          
          # Verify strategies exist and implement validate() in active code
          for strategy in packages/export/src/strategies/*.ts; do
            if [ ! -f "$strategy" ]; then continue; fi
            
            VALIDATE_IMPL=$(grep "validate" "$strategy" | grep -vE "^\s*//" || true)
            if [ -z "$VALIDATE_IMPL" ]; then
              echo "ğŸš¨ CRITICAL: Strategy $(basename $strategy) missing active validate() implementation!"
              exit 1
            fi
          done
          
          echo "âœ… S14.2: Strategy pattern compliance verified"

      - name: "S14.3 - Queue Security & Throttling"
        run: |
          echo "Verifying Queue Security Gate..."
          
          SERVICE_FILE="packages/export/src/export.service.ts"
          if [ ! -f "$SERVICE_FILE" ]; then echo "âŒ Missing $SERVICE_FILE"; exit 1; fi
          
          # Verify concurrency and active job checks in active code
          THROTTLING=$(grep -E "(concurrency|activeJobs)" "$SERVICE_FILE" | grep -vE "^\s*//" || true)
          if [ -z "$THROTTLING" ]; then
            echo "ğŸš¨ CRITICAL: Missing queue throttling or concurrency control!"
            exit 1
          fi
          
          echo "âœ… S14.3: Queue security verified"

      - name: "S14.4 - Storage Security (Presigned URLs)"
        run: |
          echo "Verifying Storage Security Compliance (S7)..."
          
          WORKER_FILE="packages/export/src/export.worker.ts"
          if [ ! -f "$WORKER_FILE" ]; then echo "âŒ Missing $WORKER_FILE"; exit 1; fi
          
          # Check for active presigned URL usage and expiry
          STORAGE_SEC=$(grep -E "(getSignedUrl|expiresIn.*24)" "$WORKER_FILE" | grep -vE "^\s*//" || true)
          if [ -z "$STORAGE_SEC" ]; then
            echo "ğŸš¨ CRITICAL: Missing secure storage access (presigned URLs with expiry)!"
            exit 1
          fi
          
          echo "âœ… S14.4: Storage security verified"

      - name: "S14.5 - Audit Logging Coverage (S4)"
        run: |
          echo "Verifying Audit Logging Coverage..."
          
          # Required audit actions in active code
          ACTIONS=("EXPORT_REQUESTED" "EXPORT_COMPLETED" "EXPORT_FAILED")
          for action in "${ACTIONS[@]}"; do
            ACTION_FOUND=$(grep -r "$action" packages/export/src/ --include="*.ts" 2>/dev/null | grep -vE "^\s*//" || true)
            if [ -z "$ACTION_FOUND" ]; then
              echo "ğŸš¨ CRITICAL: Missing active audit log for action: $action"
              exit 1
            fi
          done
          
          echo "âœ… S14.5: Audit logging verified"

      - name: "S14.6 - Access Control (Roles & Tenant)"
        run: |
          echo "Verifying Authorization Gates..."
          
          CONTROLLER="packages/export/src/export.controller.ts"
          if [ ! -f "$CONTROLLER" ]; then echo "âŒ Missing $CONTROLLER"; exit 1; fi
          
          # Verify admin role and tenant ownership check in active code
          AUTH_CHECK=$(grep -E "(role|admin|tenantId.*user.tenantId)" "$CONTROLLER" | grep -vE "^\s*//" || true)
          if [ -z "$AUTH_CHECK" ]; then
            echo "ğŸš¨ CRITICAL: Missing essential access control checks in export controller!"
            exit 1
          fi
          
          echo "âœ… S14.6: Access control verified"

      - name: "S14.7 - Data Integrity (Checksums)"
        run: |
          echo "Verifying Data Integrity (SHA-256)..."
          
          INTEGRITY=$(grep -r "SHA-256" packages/export/src/strategies/ --include="*.ts" 2>/dev/null | grep -vE "^\s*//" || true)
          if [ -z "$INTEGRITY" ]; then
            echo "ğŸš¨ CRITICAL: Missing SHA-256 checksum generation for exported data!"
            exit 1
          fi
          
          echo "âœ… S14.7: Data integrity verified"

      - name: "S14.8 - Secure Cleanup (Native vs Shell)"
        run: |
          echo "Verifying Secure Cleanup Procedures..."
          
          # [SECURITY] Detect native Node.js cleanup APIs instead of risky 'rm -rf'
          NATIVE_CLEANUP=$(grep -rE "fs\.(rm|unlink|promises\.rm)" packages/export/src/ --include="*.ts" 2>/dev/null | grep -vE "^\s*//" || true)
          
          # Check for dangerous 'rm -rf' in strings or exec
          SHELL_RM=$(grep -r "rm -rf" packages/export/src/ --include="*.ts" 2>/dev/null | grep -vE "^\s*//" || true)
          
          if [ -n "$SHELL_RM" ]; then
            echo "ğŸš¨ SECURITY ALERT: Found dangerous shell-based 'rm -rf' commands!"
            echo "Use native Node.js fs.rm() instead of exec('rm -rf') to prevent RCE."
            echo "$SHELL_RM"
            exit 1
          fi
          
          if [ -z "$NATIVE_CLEANUP" ]; then
             echo "âš ï¸ WARNING: No active cleanup logic (fs.rm) detected in export system."
          fi
          
          echo "âœ… S14.8: Cleanup procedure security verified"

      - name: S14 Final Report
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           S14 EXPORT SECURITY GATE COMPLETE                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
