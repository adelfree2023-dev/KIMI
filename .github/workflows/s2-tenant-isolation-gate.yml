name: "ğŸ”’ S2 Tenant Isolation Gate"

on:
  workflow_call:

permissions:
  contents: read
  checks: write

env:
  DATABASE_URL: postgresql://test:test@localhost:5432/test
  JWT_SECRET: test_secret_key_for_ci_environment_only_32
  NODE_ENV: test

jobs:
  s2-tenant-isolation-test:
    name: "S2 Tenant Isolation Security Test"
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 3s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: "S2.1 - Programmatic Isolation Test"
        run: |
          echo "ğŸ§ª Running Vitest S2 isolation tests..."
          # This runs the new packages/db/src/s2-isolation.test.ts
          bun run test s2-isolation.test.ts
        working-directory: packages/db

      - name: "S2.2 - Surgical Public Schema Audit"
        run: |
          echo "ğŸ” Scanning for unauthorized public schema access (Surgical)..."
          
          # Detect 'public.' references in active code
          # Explicitly ALLOWS audit logs and public decorators
          PUBLIC_REFS=$(grep -rn "public\." packages/*/src apps/*/src --include="*.ts" 2>/dev/null | \
            grep -vE "^\s*//" | \
            grep -vE "(audit|public\.decorator|node_modules|\.test\.|\.spec\.)" || true)

          if [ -n "$PUBLIC_REFS" ]; then
            echo "ğŸš¨ CRITICAL: Unauthorized public schema access detected!"
            echo "$PUBLIC_REFS"
            exit 1
          fi
          
          echo "âœ… S2.2: No unauthorized public schema access found"

      - name: S2 Final Report
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           S2 TENANT ISOLATION GATE COMPLETE                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
