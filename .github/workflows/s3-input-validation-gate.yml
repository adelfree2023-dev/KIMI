name: "ğŸ›¡ï¸ S3 Input Validation Gate"

on:
  workflow_call:

permissions:
  contents: read
  checks: write

env:
  DATABASE_URL: postgresql://test:test@localhost:5432/test
  JWT_SECRET: test_secret_key_for_ci_environment_only_32
  MINIO_ENDPOINT: localhost
  MINIO_ACCESS_KEY: test_access_key
  MINIO_SECRET_KEY: test_secret_key
  ENABLE_S1_ENFORCEMENT: "false"

jobs:
  s3-input-validation-test:
    name: "S3 Input Validation Security Test"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          cache: true

      - name: Install dependencies
        run: bun install

      - name: "S3.1 - Controller Validation Audit"
        run: |
          echo "ğŸ” Auditing controller validation (Surgical)..."
          bun run tools/security-scripts/verify-input-validation.ts

      - name: "S3.2 - SQL Injection Vector Scan"
        run: |
          echo "ğŸš¨ Scanning for SQL injection vectors (Surgical)..."
          
          # Detect dangerous string concatenation in queries (active code only)
          # Excludes safe schema management and audit services
          CONCAT=$(grep -rnE "\.(query|execute).*\+" apps/api/src packages/*/src --include="*.ts" 2>/dev/null | \
            grep -vE "^\s*//" | \
            grep -vE "(node_modules|schema-manager|audit\.service|\.test\.|\.spec\.)" || true)

          if [ -n "$CONCAT" ]; then
            echo "ğŸš¨ CRITICAL: String concatenation in SQL queries detected!"
            echo "$CONCAT"
            exit 1
          fi

          echo "âœ… S3.2: No obvious SQL injection vectors found"

      - name: S3 Final Report
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           S3 INPUT VALIDATION GATE COMPLETE                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
