name: "ğŸ“‹ S4 Audit Logging Gate"

on:
  workflow_call:

permissions:
  contents: read
  checks: write

env:
  DATABASE_URL: postgresql://test:test@localhost:5432/test
  JWT_SECRET: test_secret_key_for_ci_environment_only_32
  MINIO_ENDPOINT: localhost
  MINIO_ACCESS_KEY: test_access_key
  MINIO_SECRET_KEY: test_secret_key

jobs:
  s4-audit-logging-test:
    name: "S4 Audit Logging Security Test"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          cache: false

      - name: Install dependencies
        run: bun install

      - name: "S4.1 - Decorator Coverage Audit"
        run: |
          echo "ğŸ” Auditing @AuditLog decorator coverage (Surgical)..."
          bun run tools/security-scripts/verify-audit-logs.ts

      - name: "S4.2 - Immutable Audit Trigger Check"
        run: |
          echo "ğŸ” Checking for immutable audit triggers in active code..."
          
          # Verify that triggers are being set up in the audit service
          TRIGGERS=$(grep -rnE "(RAISE EXCEPTION.*S4 Violation|BEFORE UPDATE|BEFORE DELETE)" packages/audit/src --include="*.ts" 2>/dev/null | \
            grep -vE "^\s*//" || true)

          if [ -z "$TRIGGERS" ]; then
            echo "ğŸš¨ CRITICAL: Missing immutable audit log triggers!"
            exit 1
          fi

          echo "âœ… S4.2: Immutable audit triggers verified in codebase"

      - name: S4 Final Report
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           S4 AUDIT LOGGING GATE COMPLETE                      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
