# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# S5 Exception Handling Gate - Information Leakage Prevention
# Tests that errors don't leak sensitive information
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

name: "โ๏ธ S5 Exception Handling Gate"

on:
  workflow_call: # Only called by aggregator to avoid duplicates

permissions:
  contents: read
  checks: write

jobs:
  s5-exception-handling-test:
    name: "S5 Exception Handling Security Test"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Check Global Exception Filter
        run: |
          echo "๐ Checking for global exception filter..."

          # Check for NestJS exception filter
          EXCEPTION_FILTER=$(grep -r "ExceptionFilter\|CatchEverything\|AllExceptions" packages/*/src apps/*/src --include="*.ts" 2>/dev/null | wc -l)

          if [ "$EXCEPTION_FILTER" -eq 0 ]; then
            echo "๐จ CRITICAL: No global exception filter found!"
            echo "All errors must be caught and sanitized before reaching client"
            exit 1
          fi

          echo "โ Exception filter found: $EXCEPTION_FILTER references"

      - name: Verify No Stack Traces in Production
        run: |
          echo "๐ซ Checking for stack trace leakage..."

          # Check that stack traces are not sent to client
          # Exclude internal logging (logger.error) - that's fine and necessary
          DANGEROUS_PATTERNS=$(grep -rn "stack.*response\|error\.stack\|stackTrace.*send\|return.*stack" packages/*/src apps/*/src --include="*.ts" 2>/dev/null | \
            grep -v "node_modules\|test\|\.spec\|logger\|Logger\|log\|Log" | wc -l)

          if [ "$DANGEROUS_PATTERNS" -gt 0 ]; then
            echo "๐จ CRITICAL: Potential stack trace leakage detected!"
            grep -rn "stack.*response\|error\.stack\|stackTrace.*send\|return.*stack" packages/*/src apps/*/src --include="*.ts" 2>/dev/null | \
              grep -v "node_modules\|test\|\.spec\|logger\|Logger\|log\|Log" | head -10
            echo ""
            echo "Stack traces reveal:"
            echo "  - Internal file paths"
            echo "  - Technology stack versions"
            echo "  - Database query structures"
            echo "  - Third-party library vulnerabilities"
            exit 1
          fi

          echo "โ No stack trace leakage detected"

      - name: Check Error Response Sanitization
        run: |
          echo "๐งน Checking error response sanitization..."

          # Check for proper error response structure
          ERROR_RESPONSES=$(grep -rn "message.*error\|error.*message" packages/*/src apps/*/src --include="*.ts" 2>/dev/null | grep -E "response\|send\|json" | wc -l)

          # Look for generic error messages
          GENERIC_ERRORS=$(grep -rn '"Internal Server Error"\|"Something went wrong"\|"An error occurred"' packages/*/src apps/*/src --include="*.ts" 2>/dev/null | wc -l)

          if [ "$GENERIC_ERRORS" -eq 0 ] && [ "$ERROR_RESPONSES" -gt 0 ]; then
            echo "โ๏ธ WARNING: No generic error messages found"
            echo "Consider using generic messages in production: 'An error occurred'"
          fi

          echo "โ Error response patterns checked"

      - name: Verify Database Error Handling
        run: |
          echo "๐๏ธ Checking database error handling..."

          # Check for raw database errors being sent
          DB_ERROR_LEAKS=$(grep -rn "pg.*error\|postgres.*error\|drizzle.*error\|query.*failed\|constraint.*violation" packages/*/src apps/*/src --include="*.ts" -i 2>/dev/null | grep -E "response\|send\|return" | wc -l)

          if [ "$DB_ERROR_LEAKS" -gt 0 ]; then
            echo "๐จ CRITICAL: Database errors may leak to client!"
            grep -rn "pg.*error\|postgres.*error\|drizzle.*error" packages/*/src apps/*/src --include="*.ts" -i 2>/dev/null | grep -E "response\|send\|return" | head -5
            echo ""
            echo "Database errors reveal:"
            echo "  - Table names and structures"
            echo "  - Column names"
            echo "  - Constraint details"
            echo "  - Query syntax"
            exit 1
          fi

          echo "โ Database error handling verified"

      - name: Check GlitchTip/Sentry Integration
        run: |
          echo "๐ก Checking error monitoring integration..."

          # Check for GlitchTip, Sentry, or similar
          ERROR_MONITORING=$(grep -r "glitchtip\|sentry\|Sentry\|@sentry" packages/*/src apps/*/src --include="*.ts" -i 2>/dev/null | wc -l)

          if [ "$ERROR_MONITORING" -eq 0 ]; then
            echo "โ๏ธ WARNING: No error monitoring service found"
            echo "Consider: GlitchTip, Sentry, or LogRocket for error tracking"
          else
            echo "โ Error monitoring found: $ERROR_MONITORING references"
          fi

      - name: Verify HTTP Status Codes
        run: |
          echo "๐ Checking HTTP status code usage..."

          # Check for proper status codes
          STATUS_CODES=$(grep -r "HttpStatus\|@HttpCode\|res.status(" packages/*/src apps/*/src --include="*.ts" 2>/dev/null | wc -l)

          if [ "$STATUS_CODES" -eq 0 ]; then
            echo "โ๏ธ WARNING: No explicit HTTP status codes found"
            echo "Use appropriate status codes: 400, 401, 403, 404, 500"
          else
            echo "โ HTTP status codes found: $STATUS_CODES references"
          fi

          # Check for sensitive 500 errors
          INTERNAL_ERRORS=$(grep -rn "500\|INTERNAL_SERVER_ERROR" packages/*/src apps/*/src --include="*.ts" 2>/dev/null | grep -E "throw|new" | wc -l)
          echo "Internal error throws: $INTERNAL_ERRORS (should be minimal)"

      - name: Check Validation Error Messages
        run: |
          echo "โ Checking validation error messages..."

          # Zod validation should not expose schema details
          ZOD_ERRORS=$(grep -rn "zod.*error\|ZodError\|validation.*error" packages/*/src apps/*/src --include="*.ts" -i 2>/dev/null | wc -l)

          if [ "$ZOD_ERRORS" -gt 0 ]; then
            echo "Found $ZOD_ERRORS Zod error references"
            echo "Ensure Zod errors don't expose internal schema structures"
          fi

      - name: Test Error Boundary (Frontend)
        run: |
          echo "๐ Checking frontend error boundaries..."

          # Check for React error boundaries or similar
          ERROR_BOUNDARIES=$(grep -r "ErrorBoundary\|error-boundary\|componentDidCatch" apps/*/src --include="*.tsx" --include="*.ts" 2>/dev/null | wc -l)

          if [ "$ERROR_BOUNDARIES" -eq 0 ]; then
            echo "โ๏ธ WARNING: No frontend error boundaries found"
            echo "Frontend should catch and sanitize errors too"
          else
            echo "โ Error boundaries found: $ERROR_BOUNDARIES"
          fi

      - name: Verify Environment-Based Error Detail
        run: |
          echo "๐ง Checking environment-based error handling..."

          # Check for NODE_ENV conditional error details
          ENV_CONDITIONAL=$(grep -rn "NODE_ENV\|process.env.*env" packages/*/src apps/*/src --include="*.ts" 2>/dev/null | grep -i "error\|stack\|debug" | wc -l)

          if [ "$ENV_CONDITIONAL" -eq 0 ]; then
            echo "โ๏ธ WARNING: No environment-based error detail control"
            echo "Should show detailed errors only in development"
          else
            echo "โ Environment-based error handling found"
          fi

      - name: Report Success
        if: success()
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ S5 EXCEPTION HANDLING GATE PASSED"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ Global exception filter implemented"
          echo "โ No stack trace leakage"
          echo "โ Database errors sanitized"
          echo "โ Error monitoring configured"
          echo "โ Proper HTTP status codes used"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: Report Failure
        if: failure()
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐จ S5 EXCEPTION HANDLING GATE FAILED"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ CRITICAL: Exception handling vulnerabilities detected"
          echo ""
          echo "Impact:"
          echo "  - Stack traces leak internal implementation details"
          echo "  - Database errors reveal schema structure"
          echo "  - Attackers can map application vulnerabilities"
          echo "  - Third-party library versions exposed"
          echo ""
          echo "Required Actions:"
          echo "  1. Create global exception filter:"
          echo '     @Catch()'
          echo '     export class AllExceptionsFilter implements ExceptionFilter {...}'
          echo ""
          echo "  2. NEVER return to client:"
          echo "     - error.stack"
          echo "     - Internal file paths"
          echo "     - Database error messages"
          echo "     - Third-party library names"
          echo ""
          echo "  3. Return generic messages in production:"
          echo '     { "message": "An error occurred", "code": "ERR_001" }'
          echo ""
          echo "  4. Log full details to monitoring service (GlitchTip/Sentry)"
          echo ""
          echo "  5. Use environment-based detail levels:"
          echo '     const showDetails = process.env.NODE_ENV === "development"'
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          exit 1
