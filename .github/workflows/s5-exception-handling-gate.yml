name: "ğŸš¨ S5 Exception Handling Gate"

on:
  workflow_call:

permissions:
  contents: read
  checks: write

env:
  DATABASE_URL: postgresql://test:test@localhost:5432/test
  JWT_SECRET: test_secret_key_for_ci_environment_only_32
  MINIO_ENDPOINT: localhost
  MINIO_ACCESS_KEY: test_access_key
  MINIO_SECRET_KEY: test_secret_key
  ENABLE_S1_ENFORCEMENT: "false"

jobs:
  s5-exception-handling-test:
    name: "S5 Exception Handling Security Test"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          cache: true

      - name: Install dependencies
        run: bun install

      - name: "S5.0 - Structure Integrity Check"
        run: |
          if [ ! -f "packages/security/tsconfig.json" ]; then
            echo "ğŸš¨ CRITICAL: Security configuration missing!"
            exit 1
          fi
          if [ ! -f "packages/template-security/tsconfig.json" ]; then
            echo "ğŸš¨ CRITICAL: Template Security configuration missing!"
            exit 1
          fi

      - name: "S5.1 - Exception Filter Safety Test"
        run: |
          echo "ğŸ§ª Running Vitest exception filter safety tests..."
          # This runs the existing packages/middleware/src/exception-filter.test.ts
          # Radical Fix: Reject success if no tests are found
          bun run test exception-filter.test.ts --passWithNoTests=false
        working-directory: packages/middleware

      - name: "S5.2 - Surgical Leak Scan"
        run: |
          echo "ğŸ” Scanning for direct stack trace leaks (Surgical)..."
          
          # Detect explicit stack printing in active code
          # Excludes the exception filter itself and tests
          STACK_LEAKS=$(grep -rnE "\.stack|\.printStackTrace\(\)" packages/*/src apps/*/src --include="*.ts" 2>/dev/null | \
            grep -vE "^\s*//" | \
            grep -vE "(exception-filter\.ts|logger\.service|\.test\.|\.spec\.)" || true)

          if [ -n "$STACK_LEAKS" ]; then
            echo "ğŸš¨ CRITICAL: Potential direct stack trace leak detected!"
            echo "$STACK_LEAKS"
            exit 1
          fi
          
          echo "âœ… S5.2: No direct stack trace leaks found"

      - name: S5 Final Report
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           S5 EXCEPTION HANDLING GATE COMPLETE                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
