# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# S6 & S14: Capacity and Export Security Gate
# Merged to optimize runner usage and reduce parallel load
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸš¦ S6 & S14 Capacity Gate"

on:
  workflow_call:

jobs:
  capacity-security-test:
    name: "S6/S14 Security Test"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 2s
          --health-retries 3

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          cache: false # Temporarily disabled to clean logs (Technical Debt)

      - name: Install dependencies
        run: bun install
        env:
          ENABLE_S1_ENFORCEMENT: "true"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # S6: RATE LIMITING (Behavioral & Structural)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "S6.1 - Active Redis Connectivity Check"
        run: bun run tools/security-scripts/verify-redis-health.ts
        env:
          REDIS_URL: redis://localhost:6379
          DATABASE_URL: postgresql://test:test@localhost:5432/test

      - name: "S6.2 - Rate Limit Header Verification"
        run: |
          echo "ðŸ” Scanning for Rate Limit header implementation..."
          HEADERS=$(grep -rn "X-RateLimit-" packages/middleware/src --include="*.ts" 2>/dev/null | grep -vE "^\s*//" || true)
          if [ -z "$HEADERS" ]; then
            echo "ðŸš¨ CRITICAL: Missing Rate Limit headers in middleware!"
            exit 1
          fi
          echo "âœ… S6.2: Rate Limit headers verified"

      - name: "S6.3 - Active Throttling Stress Test"
        run: bun run tools/security-scripts/simulate-ddos-check.ts
        env:
          REDIS_URL: redis://localhost:6379
          MAX_REQUESTS: 10
          DATABASE_URL: postgresql://test:test@localhost:5432/test

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # S14: EXPORT SECURITY (Structural Scans)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "S14.1 - Tenant Isolation Verification (S2)"
        run: |
          echo "Verifying S2 Tenant Isolation in Export System..."
          ACTIVE_ISOLATION=$(grep -r "schemaName" packages/export/src --include="*.ts" 2>/dev/null | grep -vE "^\s*//" || true)
          if [ -z "$ACTIVE_ISOLATION" ]; then
            echo "ðŸš¨ CRITICAL: No active tenant schema isolation found in export queries!"
            exit 1
          fi
          PUBLIC_LEAKS=$(grep -rn "public\." packages/export/src --include="*.ts" 2>/dev/null | grep -vE "^\s*//" | grep -vE "(public.tenants|audit)" || true)
          if [ -n "$PUBLIC_LEAKS" ]; then
            echo "ðŸš¨ CRITICAL: Potential cross-tenant leak found!"
            exit 1
          fi
          echo "âœ… S14.1: Tenant isolation verified"

      - name: "S14.2 - Strategy Pattern & Implementation"
        run: |
          for strategy in packages/export/src/strategies/*.ts; do
            if [ ! -f "$strategy" ]; then continue; fi
            VALIDATE_IMPL=$(grep "validate" "$strategy" | grep -vE "^\s*//" || true)
            if [ -z "$VALIDATE_IMPL" ]; then
              echo "ðŸš¨ CRITICAL: Strategy $(basename $strategy) missing active validate()!"
              exit 1
            fi
          done
          echo "âœ… S14.2: Strategy pattern compliance verified"

      - name: "S14.3 - Queue Security & Throttling"
        run: |
          SERVICE_FILE="packages/export/src/export.service.ts"
          THROTTLING=$(grep -E "(concurrency|activeJobs)" "$SERVICE_FILE" | grep -vE "^\s*//" || true)
          if [ -z "$THROTTLING" ]; then exit 1; fi
          echo "âœ… S14.3: Queue security verified"

      - name: "S14.4 - Storage Security (Presigned URLs)"
        run: |
          WORKER_FILE="packages/export/src/export.worker.ts"
          STORAGE_SEC=$(grep -E "(getSignedUrl|expiresIn.*24)" "$WORKER_FILE" | grep -vE "^\s*//" || true)
          if [ -z "$STORAGE_SEC" ]; then exit 1; fi
          echo "âœ… S14.4: Storage security verified"

      - name: "S14.5 - Audit Logging Coverage (S4)"
        run: |
          ACTIONS=("EXPORT_REQUESTED" "EXPORT_COMPLETED" "EXPORT_FAILED")
          for action in "${ACTIONS[@]}"; do
            ACTION_FOUND=$(grep -r "$action" packages/export/src/ --include="*.ts" 2>/dev/null | grep -vE "^\s*//" || true)
            if [ -z "$ACTION_FOUND" ]; then exit 1; fi
          done
          echo "âœ… S14.5: Audit logging verified"

      - name: "S14.6 - Access Control (Roles & Tenant)"
        run: |
          CONTROLLER="packages/export/src/export.controller.ts"
          AUTH_CHECK=$(grep -E "(role|admin|tenantId.*user.tenantId)" "$CONTROLLER" | grep -vE "^\s*//" || true)
          if [ -z "$AUTH_CHECK" ]; then exit 1; fi
          echo "âœ… S14.6: Access control verified"

      - name: "S14.7 - Data Integrity (Checksums)"
        run: |
          INTEGRITY=$(grep -r "SHA-256" packages/export/src/strategies/ --include="*.ts" 2>/dev/null | grep -vE "^\s*//" || true)
          if [ -z "$INTEGRITY" ]; then exit 1; fi
          echo "âœ… S14.7: Data integrity verified"

      - name: "S14.8 - Secure Cleanup (Native vs Shell)"
        run: |
          NATIVE_CLEANUP=$(grep -rE "fs\.(rm|unlink|promises\.rm)" packages/export/src/ --include="*.ts" 2>/dev/null | grep -vE "^\s*//" || true)
          SHELL_RM=$(grep -r "rm -rf" packages/export/src/ --include="*.ts" 2>/dev/null | grep -vE "^\s*//" || true)
          if [ -n "$SHELL_RM" ]; then exit 1; fi
          echo "âœ… S14.8: Cleanup procedure security verified"

      - name: Merged Final Report
        if: always()
        run: |
          echo "S6 & S14 SECURITY GATES COMPLETE"
