# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# S8 Security Headers Gate - XSS/CSRF Protection
# Refined Surgical Scans for Real Security Configurations
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ğŸ”’ S8 Security Headers Gate"

on:
  workflow_call:

permissions:
  contents: read
  checks: write

jobs:
  s8-security-headers-test:
    name: "S8 Security Headers Test"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: "S8a - Helmet & Security Middleware Registration"
        run: |
          echo "ğŸª– Verifying Active Security Middleware Registration..."
          
          # Check for helmet registration (excluding comments)
          HELMET_REG=$(grep -rE "app\.use\(helmet\(" packages apps --include="*.ts" 2>/dev/null | grep -vE "^\s*//" || true)
          
          if [ -z "$HELMET_REG" ]; then
            echo "ğŸš¨ CRITICAL: Helmet middleware registration not found in active code!"
            echo "âŒ S8 FAILED: Missing essential security headers (Helmet)."
            exit 1
          fi
          
          # Check for security-downgrade patterns in Helmet
          HELMET_DOWNGRADE=$(grep -rE "contentSecurityPolicy\s*:\s*false|hsts\s*:\s*false" packages apps --include="*.ts" 2>/dev/null | grep -vE "^\s*//" || true)
          if [ -n "$HELMET_DOWNGRADE" ]; then
            echo "ğŸš¨ CRITICAL: Security features (CSP/HSTS) explicitly disabled in Helmet!"
            echo "$HELMET_DOWNGRADE"
            exit 1
          fi
          
          echo "âœ… Helmet middleware actively registered"

      - name: "S8b - Restricted CORS Origin Check"
        run: |
          echo "ğŸŒ Verifying CORS Restricted Origins..."
          
          # Detect wildcard origin '*' in active code
          WILDCARD_CORS=$(grep -rE "origin\s*:\s*['\"]\*['\"]|origin\s*:\s*true" packages apps --include="*.ts" --include="*.js" 2>/dev/null | grep -vE "^\s*//" || true)
          
          if [ -n "$WILDCARD_CORS" ]; then
            echo "ğŸš¨ CRITICAL: Wildcard CORS origin (*) detected in active code!"
            echo "$WILDCARD_CORS"
            echo "âŒ S8 FAILED: Insecure CORS configuration."
            exit 1
          fi
          
          echo "âœ… CORS configuration is restrictive (no wildcards)"

      - name: "S8c - Cookie Security (Secure & HttpOnly)"
        run: |
          echo "Cookie Security Attributes Audit..."
          
          # Detect security-downgrade in cooke settings
          BAD_COOKIES=$(grep -rE "secure\s*:\s*false|httpOnly\s*:\s*false" packages apps --include="*.ts" 2>/dev/null | grep -vE "^\s*//" || true)
          
          if [ -n "$BAD_COOKIES" ]; then
            echo "ğŸš¨ CRITICAL: Cookies explicitly configured as insecure (secure/httpOnly: false)!"
            echo "$BAD_COOKIES"
            echo "âŒ S8 FAILED: Insecure cookie configuration."
            exit 1
          fi
          
          # Ensure cookies are actually secure if defined
          COOKIE_DEFS=$(grep -rE "res\.cookie\(|Set-Cookie" packages apps --include="*.ts" 2>/dev/null | grep -vE "^\s*//" || true)
          if [ -n "$COOKIE_DEFS" ]; then
            MISSING_SECURE=$(echo "$COOKIE_DEFS" | grep -vE "secure\s*:\s*true" || true)
            if [ -n "$MISSING_SECURE" ]; then
              echo "âš ï¸ WARNING: Potential insecure cookies (missing 'secure: true'):"
              echo "$MISSING_SECURE"
            fi
          fi
          
          echo "âœ… Cookie security settings verified"

      - name: "S8d - CSP & Security Headers Presence"
        run: |
          echo "ğŸ›¡ï¸ Verifying CSP and Protocol Compliance..."
          
          # Scan for CSP header definitions or Helmet CSP options
          CSP_EXISTS=$(grep -rE "Content-Security-Policy|contentSecurityPolicy|csp" packages apps --include="*.ts" --include="*.js" 2>/dev/null | grep -vE "^\s*//" || true)
          
          if [ -z "$CSP_EXISTS" ]; then
            echo "âš ï¸ WARNING: No CSP configuration found. Ensure CSP is set via Helmet or manual headers."
          fi
          
          # Check for HSTS
          HSTS_EXISTS=$(grep -rE "Strict-Transport-Security|hsts" packages apps --include="*.ts" 2>/dev/null | grep -vE "^\s*//" || true)
          if [ -z "$HSTS_EXISTS" ]; then
            echo "âš ï¸ WARNING: HSTS configuration not detected."
          fi
          
          echo "âœ… Security headers structural verification complete"

      - name: "S8 Summary Report"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… S8 SECURITY HEADERS GATE COMPLETED SUCCESSFULLY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
