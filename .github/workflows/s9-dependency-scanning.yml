# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# S9: Dependency Vulnerability Scanning
# Detects vulnerable npm packages before deployment
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ”’ S9: Dependency Vulnerability Scan"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  security-events: write

jobs:
  dependency-scan:
    name: "ðŸ” Vulnerability Assessment"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: bun install
        
      - name: Run npm audit
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "              ðŸ” DEPENDENCY VULNERABILITY SCAN"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Run audit and capture output
          bun npm audit --audit-level=moderate 2>&1 || true
          
          # Check for critical vulnerabilities
          CRITICAL_COUNT=$(bun npm audit --audit-level=critical --json 2>/dev/null | jq '.metadata.vulnerabilities.critical // 0' || echo "0")
          HIGH_COUNT=$(bun npm audit --audit-level=high --json 2>/dev/null | jq '.metadata.vulnerabilities.high // 0' || echo "0")
          
          echo ""
          echo "ðŸ“Š Vulnerability Summary:"
          echo "  Critical: $CRITICAL_COUNT"
          echo "  High: $HIGH_COUNT"
          echo ""
          
          # Fail if critical vulnerabilities found
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "ðŸš¨ CRITICAL VULNERABILITIES DETECTED ðŸš¨"
            echo "Run 'bun npm audit fix' to resolve automatically"
            echo "Or review manually with 'bun npm audit'"
            exit 1
          fi
          
          if [ "$HIGH_COUNT" -gt 5 ]; then
            echo "âš ï¸  Too many HIGH severity vulnerabilities ($HIGH_COUNT)"
            echo "Review required before deployment"
            exit 1
          fi
          
          echo "âœ… Dependency scan passed"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Check for known malicious packages
        run: |
          echo "ðŸ”’ Checking for known malicious packages..."
          
          # List of known malicious package patterns
          MALICIOUS_PATTERNS="(event-stream|flatmap-stream|rc|@types/node-fetch|colors|faker)"
          
          # Check lockfile for suspicious packages
          if grep -iE "$MALICIOUS_PATTERNS" bun.lock 2>/dev/null; then
            echo "ðŸš¨ POTENTIALLY MALICIOUS PACKAGE DETECTED ðŸš¨"
            echo "Review the packages listed above immediately"
            exit 1
          fi
          
          echo "âœ… No known malicious packages detected"

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-report
          path: |
            bun.lock
            package.json
          retention-days: 30
