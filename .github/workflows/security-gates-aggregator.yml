# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Security Gates Aggregator (S1-S13)
# Runs all security gates in sequence - BLOCKS on any failure
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ğŸ”’ Security Gates (S1-S13)"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read
  checks: write
  actions: read
  pull-requests: write
  security-events: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # S1: Environment Verification (MANDATORY)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  s1-gate:
    name: "S1 Environment Verification"
    uses: ./.github/workflows/s1-env-verification-gate.yml
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # S2: Tenant Isolation (CRITICAL - Multi-tenancy)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  s2-gate:
    name: "S2 Tenant Isolation"
    uses: ./.github/workflows/s2-tenant-isolation-gate.yml
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # S3: Input Validation (Injection Prevention)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  s3-gate:
    name: "S3 Input Validation"
    uses: ./.github/workflows/s3-input-validation-gate.yml
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # S4: Audit Logging
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  s4-gate:
    name: "S4 Audit Logging"
    uses: ./.github/workflows/s4-audit-logging-gate.yml
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # S5: Exception Handling
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  s5-gate:
    name: "S5 Exception Handling"
    uses: ./.github/workflows/s5-exception-handling-gate.yml
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # S6: Rate Limiting (DDoS Protection)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  s6-gate:
    name: "S6 Rate Limiting"
    uses: ./.github/workflows/s6-rate-limiting-gate.yml
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # S7: Encryption at Rest
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  s7-gate:
    name: "S7 Encryption at Rest"
    uses: ./.github/workflows/s7-encryption-gate.yml
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # S8: Security Headers
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  s8-gate:
    name: "S8 Security Headers"
    uses: ./.github/workflows/s8-security-headers-gate.yml
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # S9-S13: Penetration Tests (Combined)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  s9-s13-penetration-tests:
    name: "S9-S13 Penetration Tests"
    uses: ./.github/workflows/security-penetration-tests.yml
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Final Security Report - BLOCKS if any gate fails
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-summary:
    name: "ğŸ”’ Security Gates Final Report"
    runs-on: ubuntu-latest
    needs:
      [s1-gate, s2-gate, s3-gate, s4-gate, s5-gate, s6-gate, s7-gate, s8-gate, s9-s13-penetration-tests]
    if: always()
    steps:
      - name: Report Security Status
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "                    ğŸ”’ SECURITY GATES REPORT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Color-coded status function
          status_icon() {
            if [ "$1" == "success" ]; then
              echo "âœ…"
            elif [ "$1" == "failure" ]; then
              echo "ğŸš¨"
            else
              echo "â­ï¸"
            fi
          }

          echo "S1-S8: Core Security"
          echo "  S1  - Environment Verification:   $(status_icon ${{ needs.s1-gate.result }}) ${{ needs.s1-gate.result }}"
          echo "  S2  - Tenant Isolation:           $(status_icon ${{ needs.s2-gate.result }}) ${{ needs.s2-gate.result }}"
          echo "  S3  - Input Validation:           $(status_icon ${{ needs.s3-gate.result }}) ${{ needs.s3-gate.result }}"
          echo "  S4  - Audit Logging:              $(status_icon ${{ needs.s4-gate.result }}) ${{ needs.s4-gate.result }}"
          echo "  S5  - Exception Handling:         $(status_icon ${{ needs.s5-gate.result }}) ${{ needs.s5-gate.result }}"
          echo "  S6  - Rate Limiting:              $(status_icon ${{ needs.s6-gate.result }}) ${{ needs.s6-gate.result }}"
          echo "  S7  - Encryption at Rest:         $(status_icon ${{ needs.s7-gate.result }}) ${{ needs.s7-gate.result }}"
          echo "  S8  - Security Headers:           $(status_icon ${{ needs.s8-gate.result }}) ${{ needs.s8-gate.result }}"
          echo ""
          echo "S9-S13: Penetration Tests"
          echo "  S9  - Dependency Scanning:        $(status_icon ${{ needs.s9-s13-penetration-tests.result }}) ${{ needs.s9-s13-penetration-tests.result }}"
          echo "  S10 - Secret Detection:           $(status_icon ${{ needs.s9-s13-penetration-tests.result }}) ${{ needs.s9-s13-penetration-tests.result }}"
          echo "  S11 - SQL Injection Test:         $(status_icon ${{ needs.s9-s13-penetration-tests.result }}) ${{ needs.s9-s13-penetration-tests.result }}"
          echo "  S12 - XSS Test:                   $(status_icon ${{ needs.s9-s13-penetration-tests.result }}) ${{ needs.s9-s13-penetration-tests.result }}"
          echo "  S13 - Red Team Simulation:        $(status_icon ${{ needs.s9-s13-penetration-tests.result }}) ${{ needs.s9-s13-penetration-tests.result }}"
          echo ""

          # Calculate compliance score
          PASSED=0
          FAILED=0
          for result in "${{ needs.s1-gate.result }}" "${{ needs.s2-gate.result }}" "${{ needs.s3-gate.result }}" "${{ needs.s4-gate.result }}" "${{ needs.s5-gate.result }}" "${{ needs.s6-gate.result }}" "${{ needs.s7-gate.result }}" "${{ needs.s8-gate.result }}" "${{ needs.s9-s13-penetration-tests.result }}"; do
            if [ "$result" == "success" ]; then
              PASSED=$((PASSED + 1))
            elif [ "$result" == "failure" ]; then
              FAILED=$((FAILED + 1))
            fi
          done

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Compliance Score: $PASSED/9 security gates passed"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Check if any gate failed - BLOCK MERGE
          if [ "$FAILED" -gt 0 ]; then
            echo "ğŸš¨ğŸš¨ğŸš¨ CRITICAL SECURITY VIOLATION ğŸš¨ğŸš¨ğŸš¨"
            echo ""
            echo "$FAILED security gate(s) FAILED"
            echo ""
            echo "â›” MERGE BLOCKED â›”"
            echo ""
            echo "Fix the failures above before merging to main."
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi

          echo "âœ…âœ…âœ… ALL SECURITY GATES PASSED âœ…âœ…âœ…"
          echo ""
          echo "The codebase meets all S1-S13 security requirements:"
          echo ""
          echo "  âœ“ S1: Environment Verification - No secrets in code"
          echo "  âœ“ S2: Tenant Isolation - Cross-tenant access blocked"
          echo "  âœ“ S3: Input Validation - Injection attacks prevented"
          echo "  âœ“ S4: Audit Logging - All operations tracked"
          echo "  âœ“ S5: Exception Handling - No information leakage"
          echo "  âœ“ S6: Rate Limiting - DDoS/Brute force protection"
          echo "  âœ“ S7: Encryption at Rest - Sensitive data encrypted"
          echo "  âœ“ S8: Security Headers - XSS/CSRF protection"
          echo "  âœ“ S9-S13: Penetration Tests - Hacker-proof verified"
          echo ""
          echo "ğŸ›¡ï¸ Code is MILITARY-GRADE SECURE ğŸ›¡ï¸"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
