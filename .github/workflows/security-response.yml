# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Security Response Workflow
# Handles security reports and coordinates response
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ğŸ›¡ï¸ Security Response"

on:
  issues:
    types: [opened, labeled]
  push:
    branches: [main]
    paths:
      - 'SECURITY.md'

jobs:
  triage-security-report:
    name: "Triage Security Report"
    runs-on: ubuntu-latest
    if: github.event.issue && contains(github.event.issue.labels.*.name, 'security')
    
    steps:
      - name: Check if public security report
        run: |
          echo "âš ï¸ Security issue opened: #${{ github.event.issue.number }}"
          echo "Title: ${{ github.event.issue.title }}"
          
          # Check if this looks like an actual vulnerability disclosure
          TITLE="${{ github.event.issue.title }}"
          BODY="${{ github.event.issue.body }}"
          
          # Keywords that indicate actual vulnerability (Surgical)
          VULN_KEYWORDS="vulnerability|exploit|RCE|SQL injection|XSS|bypass|leak|breach|unauthorized|PII|credential|CVE|0day"
          
          if echo "$TITLE $BODY" | grep -iE "$VULN_KEYWORDS"; then
            echo "ğŸš¨ POTENTIAL VULNERABILITY DISCLOSED PUBLICLY!"
            echo "needs_closing=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Likely not a vulnerability report"
            echo "needs_closing=false" >> $GITHUB_OUTPUT
          fi

      - name: Redirect to Private Vulnerability Reporting
        if: steps.triage.outputs.needs_closing == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ›¡ï¸ Security Notice
              
              Thank you for your report. However, **please do not disclose security vulnerabilities publicly**.
              
              We have enabled **GitHub Private Vulnerability Reporting**. Please use the "Report a vulnerability" button in the **Security** tab of this repository to submit your findings privately.
              
              For more details, see our [Security Policy](https://github.com/${{ github.repository }}/blob/main/SECURITY.md).
              
              This issue will be closed to prevent public disclosure.`
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              labels: ['security', 'invalid', 'wontfix']
            });

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Security Scanning on Security Policy Changes
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-security-config:
    name: "Validate Security Configuration"
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check SECURITY.md exists
        run: |
          if [ ! -f "SECURITY.md" ]; then
            echo "âŒ SECURITY.md is missing!"
            exit 1
          fi
          echo "âœ… SECURITY.md exists"

      - name: Validate Security Contact
        run: |
          if ! grep -q "security@60sec.shop" SECURITY.md; then
            echo "âŒ Security contact email not found in SECURITY.md"
            exit 1
          fi
          echo "âœ… Security contact email validated"

      - name: Check Bug Bounty Section
        run: |
          if ! grep -q "Bug Bounty" SECURITY.md; then
            echo "âŒ Bug Bounty section missing from SECURITY.md"
            exit 1
          fi
          echo "âœ… Bug Bounty section present"

      - name: Validate Scope Section
        run: |
          if ! grep -q "Scope" SECURITY.md; then
            echo "âŒ Scope section missing from SECURITY.md"
            exit 1
          fi
          echo "âœ… Scope section present"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Daily Security Metrics
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-metrics:
    name: "Security Metrics"
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Security Report
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "                    ğŸ›¡ï¸ SECURITY METRICS REPORT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Count security-related issues
          echo "ğŸ“Š Security Issues Status:"
          echo "  (Run: gh issue list --label security)"
          
          # Check last security test run
          echo ""
          echo "ğŸ”’ Last Security Pipeline Run:"
          echo "  (Check Actions tab for latest CI/CD run)"
          
          # List security features
          echo ""
          echo "âœ… Active Security Features:"
          echo "  â€¢ S1-S8 Security Gates"
          echo "  â€¢ S9-S13 Penetration Testing"
          echo "  â€¢ mTLS Inter-Service Communication"
          echo "  â€¢ Secrets Rotation"
          echo "  â€¢ Automated Alerting (Slack/PagerDuty)"
          echo "  â€¢ DAST (OWASP ZAP)"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Post to Slack (if configured)
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "ğŸ›¡ï¸ Daily Security Metrics Report\nRepository: ${{ github.repository }}\nAll security systems operational âœ…"
            }' \
            $SLACK_WEBHOOK_URL || true
